Находится по пути:
```
opt/servers/bash/clean_mattermost_files.sh
```

Файл пользователя для запуска скрипта (домашняя дирректория):
```
~/.pgpass
```

Путь к файлам Mattermost:
```
/opt/mattermost/data/
```

Команда для подключения к БД:
```
sudo -u postgres psql mattermost
```

Запрос на получение содержимого сообщений из Postgres:
```sql
SELECT message FROM posts ORDER BY createat DESC LIMIT 5;
```

Логи находятся по пути:
```
/var/log/mattermost_purge.log
```

Просмотреть логи можно в процессе работы, командой:
```
tail -f /var/log/mattermost_purge.log
```

Для работы скрипта используется **`cron`** (вызывается с помощью):
```
crontab -e
```

Сам скрипт:
```bash
#!/bin/bash

rm -f /var/log/mattermost_purge.log
touch /var/log/mattermost_purge.log

DB_NAME="mattermost"
DB_USER=#<MAIN_USER_DB>
DATA_DIR="/opt/mattermost/data"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo ""
echo ""
echo "[$DATE] Начинаем очистку Mattermost..."

echo "[1] Удаление файлов, связанных с удалёнными постами..."
psql -U "$DB_USER" -d "$DB_NAME" -At -c "
SELECT fi.Path FROM FileInfo fi
JOIN Posts p ON fi.PostId = p.Id
WHERE p.DeleteAt != 0;
" | while read -r filepath; do
    fullpath="${DATA_DIR}/${filepath}"
    if [ -f "$fullpath" ]; then
        echo "  Удаляю файл: $fullpath"
        rm -f "$fullpath"
    else
        echo "  Файл не найден (возможно, уже удалён): $fullpath"
    fi
done

echo ""
echo "[2] Удаление записей из FileInfo, привязанных к удалённым постам..."
rows=$(psql -U "$DB_USER" -d "$DB_NAME" -t -c "
DELETE FROM FileInfo
USING Posts
WHERE FileInfo.PostId = Posts.Id AND Posts.DeleteAt != 0
RETURNING FileInfo.Id;
")
if [ -n "$rows" ]; then
    echo "  ✅ Удалено записей FileInfo: $(echo "$rows" | wc -l)"
else
    echo "  ℹ️  Нет записей FileInfo для удаления."
fi

echo ""
echo "[3] Удаление самих удалённых сообщений из Posts..."
deleted_posts=$(psql -U "$DB_USER" -d "$DB_NAME" -t -c "
WITH deleted AS (
    DELETE FROM Posts
    WHERE DeleteAt != 0
    RETURNING Id, Message
)
SELECT Id || '|' || coalesce(Message,'') FROM deleted;
")

if [ -n "$deleted_posts" ]; then
    echo "$deleted_posts" | while IFS='|' read -r id message; do
        
        #short_msg=$(echo "$message" | cut -c1-50)
		msg_len=$(echo -n "$message" | wc -c)

		if [ "$msg_len" -gt 50 ]; then
		  echo "  Сообщение удалено (ID: $id)..."
		else
		  echo "  Сообщение удалено (ID: $id)"
		fi

    done
    deleted_count=$(echo "$deleted_posts" | wc -l)
    echo "  ✅ Удалено сообщений: $deleted_count"
else
    echo "  ℹ️  Нет удалённых сообщений для удаления."
fi

echo "[$DATE] Очистка завершена ✅"
echo ""
```

**Сам скрипт выполняет очистку каждые 25 минут**

cron's config:
```
*/25 * * * * /opt/servers/bash/clean_mattermost_files.sh /var/log/mattermost_purge.log
```